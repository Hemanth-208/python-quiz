<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberTeam - Hardcore Sprint</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --blue: #00f3ff; --green: #00ff41; --pink: #ff00ff; --red: #ff3131; --bg: #05080a; }
        body { font-family: 'Courier New', monospace; background: var(--bg); color: #fff; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; overflow-x: hidden; }
        .container { width: 95%; max-width: 700px; border: 2px solid var(--blue); padding: 25px; background: rgba(0,0,0,0.95); box-shadow: 0 0 20px var(--blue); position: relative; }
        
        /* Buttons & Inputs */
        .btn { background: transparent; color: var(--blue); border: 1px solid var(--blue); padding: 12px; cursor: pointer; width: 100%; margin: 8px 0; text-transform: uppercase; font-family: inherit; transition: 0.2s; }
        .btn:hover:not(:disabled) { background: var(--blue); color: #000; box-shadow: 0 0 10px var(--blue); }
        .mini-btn { width: auto; padding: 4px 8px; font-size: 0.7em; color: var(--red); border: 1px solid var(--red); margin-left: 10px; display: inline-block; }
        .mini-btn:hover { background: var(--red); color: #000; }
        .input-f { width: 100%; padding: 15px; background: transparent; border: 1px solid var(--green); color: var(--green); margin: 10px 0; outline: none; font-family: inherit; box-sizing: border-box; }
        
        .hidden { display: none; }
        
        /* Quiz UI */
        .score-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #222; }
        .timer-bar { height: 5px; background: var(--pink); width: 100%; transition: width 1s linear; margin-bottom: 15px; }
        #q-text { font-size: 1.2em; margin-bottom: 20px; border-left: 3px solid var(--blue); padding-left: 10px; min-height: 50px; }
        
        /* Status Text */
        .dq-text { color: var(--red); font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        .waiting-msg { color: var(--green); text-align: center; font-style: italic; margin: 20px 0; }
    </style>
</head>
<body>

<div class="container">
    <div id="start-menu">
        <h2 style="color:var(--blue); text-align:center;">[ SYSTEM_CORE_v2 ]</h2>
        <button class="btn" onclick="showCreate()">Host as Creator</button>
        <button class="btn" onclick="showJoin()">Join as Player</button>
    </div>

    <div id="create-screen" class="hidden">
        <h2 style="color:var(--blue)">Creator Console</h2>
        <input type="text" id="c-name" class="input-f" placeholder="ENTER YOUR NAME">
        <button class="btn" onclick="createRoom()">Generate Room Code</button>
    </div>

    <div id="join-screen" class="hidden">
        <h2 style="color:var(--blue)">Sync Protocol</h2>
        <input type="text" id="room-id" class="input-f" placeholder="4-DIGIT CODE">
        <input type="text" id="p-name" class="input-f" placeholder="YOUR NAME">
        <button class="btn" onclick="joinRoom()">Connect to Host</button>
    </div>

    <div id="lobby-screen" class="hidden">
        <h3 id="display-host"></h3>
        <p>ROOM CODE: <span id="display-code" style="color:var(--pink); font-size:2em"></span></p>
        <div id="player-list" style="margin:20px 0; border:1px dashed #444; padding:10px;"></div>
        <button id="start-btn" class="btn hidden" onclick="startQuiz()">ACTIVATE SPRINT</button>
    </div>

    <div id="quiz-screen" class="hidden">
        <div id="timer-ui" class="timer-bar"></div>
        <div style="display: flex; justify-content: space-between; color: var(--pink); font-size: 0.8em; margin-bottom: 5px;">
            <span id="q-count">NODE 1/20</span>
            <span id="timer-num">30s</span>
        </div>
        <div id="q-text"></div>
        <div id="interaction-zone"></div>
        <div id="live-leaderboard" style="margin-top:30px; border-top:1px solid var(--blue); padding-top:15px"></div>
    </div>

    <div id="dq-screen" class="hidden" style="text-align:center;">
        <h1 class="dq-text" style="font-size:2.5em;">ACCESS DENIED</h1>
        <p style="color:var(--red);">TAB SWITCH DETECTED. YOU ARE DISQUALIFIED.</p>
        <p style="color:var(--blue); font-size: 0.8em;">Contact the Creator to request UN-DQ.</p>
    </div>

    <div id="result-screen" class="hidden">
        <h2 style="color:var(--blue); text-align:center;">[ MISSION_SUMMARY ]</h2>
        <div id="final-stats"></div>
        <button class="btn" onclick="location.reload()">Reboot System</button>
    </div>
</div>

<script>
// REPLACE WITH YOUR FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyB-EQmy86TNealf_VZB32H3p-bWSyDNE9k",
  authDomain: "cyberquizsync.firebaseapp.com",
  projectId: "cyberquizsync",
  storageBucket: "cyberquizsync.firebasestorage.app",
  messagingSenderId: "241572824298",
  appId: "1:241572824298:web:8941756bda23f03af8c393",
  measurementId: "G-WRS1YXN3T2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let roomCode = "", myName = "", isHost = false, myCurrentIdx = -1, isDQ = false;
let timerInt;

const questions = [
    {q: "Which component is known as the brain of the computer?", o: ["RAM", "Hard Disk", "CPU", "Monitor"], a: 2},
    {q: "Which memory is volatile?", o: ["ROM", "RAM", "SSD", "HDD"], a: 1},
    {q: "What does HTTP stand for?", o: ["Hyper Text Transfer Protocol", "High Text Transfer Protocol", "Hyper Transfer Text Process", "Hyper Tool Protocol"], a: 0},
    {q: "Which device converts digital signals to analog?", o: ["Router", "Modem", "Switch", "Hub"], a: 1},
    {q: "Which of the following is an input device?", o: ["Printer", "Plotter", "Scanner", "Speaker"], a: 2},
    {q: "Shortcut key to copy text in Windows?", o: ["Ctrl + V", "Ctrl + C", "Ctrl + X", "Ctrl + Z"], a: 1},
    {q: "Full form of CPU is:", o: ["Central Processing Unit", "Computer Processing Unit", "Central Program Unit", "Control Processing Unit"], a: 0},
    {q: "Which of the following is system software?", o: ["MS Excel", "Windows OS", "Photoshop", "Chrome"], a: 1},
    {q: "Number system used by computers internally?", o: ["Decimal", "Octal", "Binary", "Hexadecimal"], a: 2},
    {q: "Which part temporarily stores data/instructions?", o: ["Cache", "ROM", "RAM", "Hard Disk"], a: 2},
    {q: "File extension used for Excel files?", o: [".docx", ".xlsx", ".pptx", ".txt"], a: 1},
    {q: "What is the function of an operating system?", o: ["Compile programs", "Manage hardware resources", "Create documents", "Browse internet"], a: 1},
    {q: "Which key is used to refresh a webpage?", o: ["F1", "F2", "F5", "F10"], a: 2},
    {q: "Which of the following is NOT a programming language?", o: ["Python", "Java", "HTML", "Oracle"], a: 3},
    {q: "Which storage device has the fastest access time?", o: ["Hard Disk", "CD-ROM", "SSD", "Floppy Disk"], a: 2},
    {q: "What does URL stand for?", o: ["Uniform Resource Locator", "Universal Resource Link", "Unique Reference Location", "Unified Resource Link"], a: 0},
    {q: "What is used to protect a computer from viruses?", o: ["Firewall", "Antivirus", "Router", "Modem"], a: 1},
    {q: "Topology connecting all devices to a central hub?", o: ["Ring", "Bus", "Star", "Mesh"], a: 2},
    {q: "What is the full form of USB?", o: ["Universal System Bus", "Unique Serial Bus", "Universal Serial Bus", "Unified Service Bus"], a: 2},
    {q: "Example of cloud storage?", o: ["Pen Drive", "Google Drive", "DVD", "Hard Disk"], a: 1}
];

function hide() { ['start-menu','create-screen','join-screen','lobby-screen','quiz-screen','result-screen','dq-screen'].forEach(id => document.getElementById(id).classList.add('hidden')); }
function showCreate() { hide(); document.getElementById('create-screen').classList.remove('hidden'); }
function showJoin() { hide(); document.getElementById('join-screen').classList.remove('hidden'); }

// --- ANTI-CHEAT LOGIC ---
window.addEventListener('blur', () => { if(!isHost && !isDQ && roomCode) handleDQ(); });
document.addEventListener('visibilitychange', () => { if(document.hidden && !isHost && !isDQ && roomCode) handleDQ(); });

function handleDQ() {
    db.ref(`rooms/${roomCode}/status`).once('value', (s) => {
        if(s.val() === 'playing') {
            isDQ = true;
            clearInterval(timerInt);
            db.ref(`rooms/${roomCode}/players/${myName}`).update({ disqualified: true });
        }
    });
}

// --- CORE FUNCTIONS ---
function createRoom() {
    myName = document.getElementById('c-name').value.trim();
    if(!myName) return;
    roomCode = Math.floor(1000 + Math.random() * 9000).toString();
    isHost = true;
    db.ref('rooms/' + roomCode).set({ status: 'lobby', creator: myName });
    initSync();
}

function joinRoom() {
    roomCode = document.getElementById('room-id').value.trim();
    myName = document.getElementById('p-name').value.trim();
    if(!roomCode || !myName) return;
    db.ref(`rooms/${roomCode}/players/${myName}`).set({ points: 0, currentQ: 0, done: false, disqualified: false });
    initSync();
}

function initSync() {
    db.ref('rooms/' + roomCode).on('value', (snap) => {
        const data = snap.val();
        if(!data) return;
        
        if(data.status === 'lobby') {
            hide(); document.getElementById('lobby-screen').classList.remove('hidden');
            document.getElementById('display-host').innerText = `CREATOR: ${data.creator}`;
            document.getElementById('display-code').innerText = roomCode;
            let list = `<strong>SYNCED PLAYERS:</strong>`;
            for(let p in data.players) { list += `<div>> ${p}</div>`; }
            document.getElementById('player-list').innerHTML = list;
            if(isHost) document.getElementById('start-btn').classList.remove('hidden');
        }

        if(data.status === 'playing') {
            const myData = data.players ? data.players[myName] : null;
            
            // Sync DQ status (Allows for Mercy button)
            if(!isHost && isDQ && myData && !myData.disqualified) {
                isDQ = false; // Restore
            }

            if(isDQ && !isHost) {
                hide(); document.getElementById('dq-screen').classList.remove('hidden');
            } else {
                hide(); document.getElementById('quiz-screen').classList.remove('hidden');
                updateLeaderboard(data.players);
                if(!isHost && myData) {
                    if(myData.done) {
                        document.getElementById('q-text').innerText = "ALL NODES COMPLETED";
                        document.getElementById('interaction-zone').innerHTML = "<p class='waiting-msg'>Waiting for mission end...</p>";
                        clearInterval(timerInt);
                    } else {
                        renderQuestion(myData.currentQ);
                    }
                } else {
                    document.getElementById('q-text').innerText = "MONITORING LIVE SPRINT...";
                    document.getElementById('timer-ui').style.visibility = 'hidden';
                }
            }
        }

        if(data.status === 'finished') {
            hide(); document.getElementById('result-screen').classList.remove('hidden');
            updateLeaderboard(data.players, 'final-stats');
        }
    });
}

function renderQuestion(qIdx) {
    if(myCurrentIdx !== qIdx) {
        myCurrentIdx = qIdx;
        const q = questions[qIdx];
        document.getElementById('q-count').innerText = `NODE ${qIdx + 1}/20`;
        document.getElementById('q-text').innerText = q.q;
        let opts = "";
        q.o.forEach((o, i) => { opts += `<button class="btn" onclick="checkAnswer(${i}, ${qIdx})">${o}</button>`; });
        document.getElementById('interaction-zone').innerHTML = opts;
        startTimer();
    }
}

function startTimer() {
    clearInterval(timerInt);
    let timeLeft = 30;
    const bar = document.getElementById('timer-ui');
    const num = document.getElementById('timer-num');
    timerInt = setInterval(() => {
        timeLeft--;
        num.innerText = timeLeft + "s";
        bar.style.width = (timeLeft / 30 * 100) + "%";
        if(timeLeft <= 0) moveNext();
    }, 1000);
}

function checkAnswer(idx, qIdx) {
    document.getElementById('interaction-zone').innerHTML = ""; // One-strike: remove buttons instantly
    if(idx === questions[qIdx].a) {
        db.ref(`rooms/${roomCode}/players/${myName}/points`).transaction(p => (p || 0) + 2);
    }
    moveNext();
}

function moveNext() {
    clearInterval(timerInt);
    const nextIdx = myCurrentIdx + 1;
    if(nextIdx < questions.length) {
        db.ref(`rooms/${roomCode}/players/${myName}`).update({ currentQ: nextIdx });
    } else {
        db.ref(`rooms/${roomCode}/players/${myName}`).update({ done: true });
        checkRoomFinished();
    }
}

function checkRoomFinished() {
    db.ref(`rooms/${roomCode}/players`).once('value', snap => {
        let allDone = true;
        snap.forEach(p => { if(!p.val().done && !p.val().disqualified) allDone = false; });
        if(allDone) db.ref('rooms/' + roomCode).update({ status: 'finished' });
    });
}

function startQuiz() { db.ref('rooms/' + roomCode).update({ status: 'playing' }); }

function updateLeaderboard(players, targetId = 'live-leaderboard') {
    let scores = [];
    for(let p in players) { 
        scores.push({ 
            name: p, 
            pts: players[p].points || 0, 
            dq: players[p].disqualified || false 
        }); 
    }
    scores.sort((a,b) => b.pts - a.pts);
    
    let html = "<strong>RANKINGS:</strong>";
    scores.forEach((s, i) => {
        const color = s.dq ? 'var(--red)' : 'var(--green)';
        const dqLabel = s.dq ? `<span class="dq-text"> [DQ]</span>` : '';
        const mercyBtn = (isHost && s.dq) ? `<button class="mini-btn" onclick="giveMercy('${s.name}')">UN-DQ</button>` : '';
        
        html += `<div class="score-row" style="color:${color}">
                    <span>#${i+1} ${s.name}${dqLabel}${mercyBtn}</span>
                    <span>${s.pts} PTS</span>
                 </div>`;
    });
    document.getElementById(targetId).innerHTML = html;
}

function giveMercy(pName) {
    db.ref(`rooms/${roomCode}/players/${pName}`).update({ disqualified: false });
}
</script>
</body>
</html>
