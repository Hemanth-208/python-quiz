<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CyberTeam Terminal</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --blue: #00f3ff; --green: #00ff41; --pink: #ff00ff; --bg: #05080a; }
        body { font-family: 'Courier New', monospace; background: var(--bg); color: #fff; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { width: 90%; max-width: 600px; border: 2px solid var(--blue); padding: 30px; background: rgba(0,0,0,0.95); box-shadow: 0 0 20px var(--blue); }
        .btn { background: transparent; color: var(--blue); border: 1px solid var(--blue); padding: 15px; cursor: pointer; width: 100%; margin: 10px 0; text-transform: uppercase; font-family: inherit; }
        .btn:hover { background: var(--blue); color: #000; box-shadow: 0 0 10px var(--blue); }
        .input-f { width: 100%; padding: 15px; background: transparent; border: 1px solid var(--green); color: var(--green); margin: 10px 0; outline: none; font-family: inherit; }
        .hidden { display: none; }
        .score-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #222; color: var(--green); }
    </style>
</head>
<body>

<div class="container" id="terminal">
    <div id="start-menu">
        <h2 style="color:var(--blue)">[ SYSTEM_INIT ]</h2>
        <button class="btn" onclick="showCreate()">Create Team (Creator)</button>
        <button class="btn" onclick="showJoin()">Join Team (Teammate)</button>
    </div>

    <div id="create-screen" class="hidden">
        <input type="text" id="team-name" class="input-f" placeholder="TEAM NAME...">
        <button class="btn" onclick="createTeam()">Get Team Code</button>
    </div>

    <div id="join-screen" class="hidden">
        <input type="text" id="join-code" class="input-f" placeholder="ENTER 4-DIGIT CODE">
        <input type="text" id="p-name" class="input-f" placeholder="YOUR NAME">
        <button class="btn" onclick="joinTeam()">Link to Team</button>
    </div>

    <div id="lobby-screen" class="hidden">
        <h3 id="team-display" style="color:var(--blue)"></h3>
        <p>GIVE THIS CODE TO TEAM: <span id="code-display" style="color:var(--pink); font-size:1.8em"></span></p>
        <p style="color:var(--green); font-size:0.9em">Players joined: <span id="player-count" style="color:var(--pink)">0</span></p>
        <div id="player-list" style="border:1px dashed #444; padding:15px; margin:20px 0; min-height:40px;"></div>
        <button id="start-btn" class="btn hidden" onclick="startQuiz()">START QUIZ (CREATOR ONLY)</button>
    </div>

    <div id="quiz-screen" class="hidden">
        <div id="q-text" style="margin-bottom:20px; font-size:1.2em; border-left: 3px solid var(--blue); padding-left:10px;"></div>
        <div id="options"></div>
        <div id="leaderboard" style="margin-top:30px; border-top:1px solid var(--blue); padding-top:15px"></div>
    </div>
</div>

<script>
// Your specific Firebase Config from image_a90fa0.png
const firebaseConfig = {
  apiKey: "AIzaSyB-EQmy86TNealf_VZB32H3p-bWSyDNE9k",
  authDomain: "cyberquizsync.firebaseapp.com",
  projectId: "cyberquizsync",
  storageBucket: "cyberquizsync.firebasestorage.app",
  messagingSenderId: "241572824298",
  appId: "1:241572824298:web:8941756bda23f03af8c393",
  measurementId: "G-WRS1YXN3T2"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let roomCode = "";
let playerName = "";
let isHost = false;

// Question Bank
const questions = [
    {q: "Which hardware is the brain of the PC?", o: ["RAM", "CPU", "Disk"], a: 1},
    {q: "Which memory is volatile?", o: ["ROM", "RAM", "SSD"], a: 1},
    {q: "What connects computers in a LAN?", o: ["Switch", "Scanner", "Printer"], a: 0}
];

// Navigation Functions
function showCreate() { hide(); document.getElementById('create-screen').classList.remove('hidden'); }
function showJoin() { hide(); document.getElementById('join-screen').classList.remove('hidden'); }
function hide() { ['start-menu','create-screen','join-screen','lobby-screen','quiz-screen'].forEach(id => document.getElementById(id).classList.add('hidden')); }

// Logic: Create Team
function createTeam() {
    const tName = document.getElementById('team-name').value;
    if(!tName) { alert("Please enter a team name!"); return; }
    roomCode = Math.floor(1000 + Math.random() * 9000).toString();
    isHost = true;
    playerName = "CREATOR";
    db.ref('rooms/' + roomCode).set({ teamName: tName, status: 'lobby', currentQ: 0, players: { "CREATOR": { points: 0 } } })
        .then(() => { console.log("Team created:", roomCode); initSync(); })
        .catch(err => { alert("Error creating team: " + err.message); console.error(err); });
}

// Logic: Join Team
function joinTeam() {
    roomCode = document.getElementById('join-code').value;
    playerName = document.getElementById('p-name').value;
    if(!roomCode || !playerName) { alert("Please enter code and name!"); return; }
    
    console.log("Attempting to join room:", roomCode, "as:", playerName);
    
    // First check if the room exists
    db.ref('rooms/' + roomCode).once('value')
        .then(snap => {
            console.log("Room check result:", snap.exists(), snap.val());
            if(!snap.exists()) { 
                alert("Team code not found! Ask creator for correct code."); 
                return; 
            }
            // Room exists, now add player
            const playerRef = db.ref(`rooms/${roomCode}/players/${playerName}`);
            playerRef.set({ points: 0 })
                .then(() => { 
                    console.log("Player added successfully:", playerName);
                    alert("Joined team! Waiting for quiz to start...");
                    initSync(); 
                })
                .catch(err => { 
                    console.error("Error joining:", err);
                    alert("Error joining team: " + err.message); 
                });
        })
        .catch(err => { 
            console.error("Connection error:", err);
            alert("Connection error: " + err.message); 
        });
}

// Real-time Sync Engine
function initSync() {
    db.ref('rooms/' + roomCode).on('value', (snap) => {
        const data = snap.val();
        if(!data) { console.log("No room data found"); return; }
        console.log("Room data:", data);
        
        if(data.status === 'lobby') {
            hide(); document.getElementById('lobby-screen').classList.remove('hidden');
            document.getElementById('team-display').innerText = `TEAM: ${data.teamName}`;
            document.getElementById('code-display').innerText = roomCode;
            
            let list = "<strong>PLAYERS READY:</strong>";
            let playerCount = 0;
            if(data.players) {
                for(let p in data.players) { 
                    list += `<div style="color:var(--green); margin:5px 0;">>> ${p}</div>`; 
                    playerCount++;
                }
            }
            document.getElementById('player-list').innerHTML = list;
            document.getElementById('player-count').innerText = playerCount;
            
            if(isHost) document.getElementById('start-btn').classList.remove('hidden');
        }

        if(data.status === 'playing') {
            hide(); document.getElementById('quiz-screen').classList.remove('hidden');
            const q = questions[data.currentQ];
            document.getElementById('q-text').innerText = `NODE_${data.currentQ + 1}: ${q.q}`;
            let opts = "";
            q.o.forEach((o, i) => { opts += `<button class="btn" onclick="checkAns(${i}, ${data.currentQ})">${o}</button>`; });
            document.getElementById('options').innerHTML = opts;
            
            let scores = "<strong>LIVE POINTS:</strong>";
            if(data.players) {
                for(let p in data.players) { scores += `<div class="score-row"><span>${p}</span><span>${data.players[p].points}</span></div>`; }
            }
            document.getElementById('leaderboard').innerHTML = scores;
        }
    }, err => { console.error("Database error:", err); alert("Database connection error!"); });
}

function startQuiz() { db.ref('rooms/' + roomCode).update({ status: 'playing' }); }

function checkAns(idx, qIdx) {
    console.log("Answer selected:", idx, "Correct:", questions[qIdx].a);
    if(idx === questions[qIdx].a) {
        alert("✓ CORRECT! +10 points");
        // Correct answer! Update points in Firebase
        db.ref(`rooms/${roomCode}/players/${playerName}/points`).transaction(p => (p || 0) + 10)
            .then(() => {
                // Advance question for the whole room
                if(qIdx + 1 < questions.length) {
                    db.ref('rooms/' + roomCode).update({ currentQ: qIdx + 1 });
                } else {
                    alert("QUIZ COMPLETE!");
                    location.reload();
                }
            });
    } else {
        alert("✗ WRONG! Try the next one.");
        console.log("Wrong answer");
    }
}
</script>
</body>
</html>
